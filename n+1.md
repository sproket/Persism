# Persism and the SELECT N+1 problem

Virtually all ORMs out there have mechanisms to support some kind of join or relationship where you 
have - let's say a Customer object which has a List of Invoice objects. Persism has not had anything
much to say about this - leaving it up to you to handle this situation on your own.

The reason for this mainly was I wanted to avoid the "impedance mismatch" problems inherent 
when you are combining OO/Procedural languages with SQL which is a declarative query language.

## So what is the SELECT N+1 problem?

The N+1 query problem can happen when the ORM executes N additional SQL statements to fetch 
the data for child tables.

So we have a relationship of Customer -> Invoices -> LineItems -> Product

```java
public final class Customer {

    private String customerId;
    private String customerName;
    private String region;
    private String country;

    private List<Invoice> invoices = new ArrayList<>();
}

public final class Invoice {
    private int invoiceId;
    private String customerId;
    privtate Date invoiceDate;
    private double total;
    
    private List<LineItem> lineItems = new ArrayList<>();
} 

public final class LineItem {
    private int lineItemId;
    private int invoiceId;
    private int productId;
    private double price;     

    private Product product;
} 

public final class Product {
    private int productId;
    private String description;
    private double price;
} 
```

So what happens if we SELECT 1 Customer? That would mean 1 query to get the customer, 1 query to get the invoices for 
the customer, FOR EACH invoice query to get the line items for the invoice, FOR EACH line item a query to get the product.

If on average each customer had 50 invoices with 50 line items that would be 2500 additional queries to the database!

And it gets much worse if you were selecting hundreds of customers.

## So how did I handle this situation?

In most cases I was able to avoid this by thinking in terms of the specific user requirement. If the user really just 
wanted a grid to display customer name, total number of invoices, total price and region. I would write and test an 
SQL query with this specific information and place it in a View mapped to a Record.

But in some cases I really did want objects in a hierarchy in situations where I was responding with JSON to a web 
service or for a web page request.

So how did I handle it? ![Goodbye N](img/BootN.png) By kicking out the N.

* I select from customers then collect their customerIds
* Use this list of customerIds to select invoices `(SELECT FROM Invoices WHERE CustomerID IN (1,2,3,4,5))`
* Use this list of invoiceIds to get the LineItems `(SELECT FROM LineItems WHERE InvoiceID IN (5,6,7,8,9))`
* Use this list of LineItem productIds to get the Products `(SELECT FROM Products WHERE ProductID IN (10,11,12))`

And then stitch all this together.

![Figure. Photo by: Alan King](https://www.cmaj.ca/content/cmaj/169/12/1294/F1.medium.gif)


Now instead of potentially 2502 queries I only have 4 + plus some work in memory to put everything together.

## So how does this work out?

Generally this approach works well as long as you have indexes and your results are not too large. Most Databases
have some limit to the `IN (?,?,?)` expression though - some maximum number of parameters which varies depending 
on the DB.

So it's not a perfect solution.



menton infinite loops!

[Discuss hgere](https://github.com/sproket/Persism/issues/26)


##star trek Medusans 

<iframe width="560" height="315" src="https://www.youtube.com/embed/Ljhqz6pF_Uo" title="YouTube video player" 
frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; 
picture-in-picture" allowfullscreen></iframe>

<iframe width="560" height="315" src="https://www.youtube.com/embed/txFjpTX0v0E" title="YouTube video player" 
frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; 
picture-in-picture" allowfullscreen></iframe>

So in the end, what do you think of my Solution?

<iframe width="560" height="315" src="https://www.youtube.com/embed/AhdJuYoVVZ0" title="What do you think of my solution?"
frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope;
picture-in-picture" allowfullscreen></iframe>
